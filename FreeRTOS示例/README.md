# FreeRTOS

FreeRTOS的示例

- 开发环境：VS Code + EIDE插件
- 硬件：STM32F103C8T6最小系统板

## 示例1 队列

**硬件接线**

|   器件   | 器件引脚 |   STM32引脚   |
| :------: | :------: | :-----------: |
| 光敏电阻 |    AO    |      PB1      |
|   OLED   |   SCL    |      PB6      |
|          |   SDA    |      PB7      |
|          |   VCC    |      PB5      |
|          |   GND    |      PB4      |
| 3个LED灯 |    -     | PA0、PA1、PA2 |

**光照采集、LED、OLED任务**

光敏传感器采集光照强度；LED1~LED3反应光照的强度，3灯全亮表示最暗，灯全部熄灭表示最亮；OLED实时显示光照强度。

任务分析：

- OLED显示光照强度，任务优先级最低
- LED亮灭任务，任务优先级中
- 光照采集任务，光敏电阻使用ADC读取，范围0~4095，任务优先级高

使用两个队列，xLightQueue接收光照数据并发送给LED亮灭任务，LED亮灭任务将接收到的数据发送xDisplayQueue用于OLED显示任务，整个过程：

**光照采集任务**-----发送数据---->xLightQueue------读取数据----->**LED亮灭任务**-----发送数据---->xDisplayQueue------读取数据----->**OLED显示任务**

## 示例2 信号量

**硬件接线**

|   器件   | 器件引脚 |   STM32引脚   |
| :------: | :------: | :-----------: |
| 光敏电阻 |    AO    |      PB1      |
| 按键1、2 |    -     |   PB0、PB11   |
|   OLED   |   SCL    |      PB6      |
|          |   SDA    |      PB7      |
|          |   VCC    |      PB5      |
|          |   GND    |      PB4      |
| 3个LED灯 |    -     | PA0、PA1、PA2 |

**任务需求**，四个任务：

- 光照采集任务：当采集的光照强度小于阈值，向LED任务发送二值信号量
- LED任务：接收到来自光照采集任务的二值信号量，点亮LED灯，并释放二值信号量
- 按键任务：Key1、Key2两个按键，按下Key1，计数信号量+1，按下Key2，计数信号量-1，上限为10
- OLED任务：实时显示光照强度、显示LED亮灭情况、显示已用资源个数（上限为10个）

**优先级划分**：按键任务 > OLED任务 > 光照采集任务 > LED任务

## 示例3 中断服务程序中使用信号量

**硬件接线**

|    器件    | 器件引脚 |   STM32引脚   |
| :--------: | :------: | :-----------: |
|  光敏电阻  |    AO    |      PB1      |
|  按键1、2  |    -     |   PB0、PB11   |
|    OLED    |   SCL    |      PB6      |
|            |   SDA    |      PB7      |
|            |   VCC    |      PB5      |
|            |   GND    |      PB4      |
|  3个LED灯  |    -     | PA0、PA1、PA2 |
| USB to TTL |    RX    |      PA9      |
|            |    TX    |     PA10      |
|            |   GND    |      GND      |

**任务需求**，五个任务：

- 光照采集任务：当采集的光照强度小于阈值，向LED任务发送二值信号量
- LED任务：接收到来自光照采集任务的二值信号量，点亮LED灯，并释放二值信号量
- 按键任务：Key1、Key2两个按键，按下Key1，计数信号量+1，按下Key2，计数信号量-1，上限为10
- OLED任务：实时显示光照强度、显示LED亮灭情况、显示已用资源个数（上限为10个）
- 串口发送任务：使用串口发送中断和信号量实现，每2s发送一次数据。

**优先级划分**：按键任务 > OLED任务 > 光照采集任务 > LED任务 = 串口发送任务

串口发送任务是周期性的任务，因此任务优先级应该设置为低。如果串口发送任务优先级高于LED任务，LED任务由于优先度低于所有的任务，而FreeRTOS是抢占式的调度方式（优先执行高优先级的任务），LED任务不会被执行。

## 示例4 任务通知代替信号量

与示例3类似，只是将串口发送任务中的信号量改成任务通知。

## 示例5 消息缓冲区

**任务需求**，两个任务：

- Key按键检测任务：两个按键，一个按键发送哭脸的字符数组至消息缓冲区，令一个按键发送笑脸至消息缓冲区，实现笑/哭脸的来回切换。其中发送的数据是结构体，head部分如果是0x00，则表示是哭脸；是0x01，则表示是笑脸。
- OLED显示任务：从消息缓冲区读取数据，绘制出笑脸、哭脸并显示smile、cry等字符

**硬件接线**

|   器件   | 器件引脚 | STM32引脚 |
| :------: | :------: | :-------: |
| 按键1、2 |    -     | PB0、PB11 |
|   OLED   |   SCL    |    PB6    |
|          |   SDA    |    PB7    |
|          |   VCC    |    PB5    |
|          |   GND    |    PB4    |
